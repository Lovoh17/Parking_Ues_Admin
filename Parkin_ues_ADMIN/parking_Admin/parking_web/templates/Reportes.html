{% extends 'base.html' %}
{% load report_filters %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-lg p-6 text-white shadow-lg">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 fw-bold mb-2">
                            <i class="fas fa-file-alt me-3"></i>{{ titulo }}
                        </h1>
                        <div class="d-flex align-items-center gap-4">
                            <p class="mb-0 opacity-90">
                                <i class="fas fa-calendar-alt me-2"></i>Generado el {{ fecha_generacion }}
                            </p>
                            <p class="mb-0 opacity-90">
                                <i class="fas fa-database me-2"></i>{{ total_registros }} registro{{ total_registros|pluralize }}
                            </p>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-light btn-lg dropdown-toggle shadow" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Exportar
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li>
                                <a class="dropdown-item" href="?tipo_reporte={{ tipo_reporte }}&formato=pdf">
                                    <i class="fas fa-file-pdf text-danger me-2"></i>PDF
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="?tipo_reporte={{ tipo_reporte }}&formato=excel">
                                    <i class="fas fa-file-excel text-success me-2"></i>Excel
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="?tipo_reporte={{ tipo_reporte }}&formato=json">
                                    <i class="fas fa-code text-info me-2"></i>JSON
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Selector de tipo de reporte -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-bottom-0">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-filter me-2 text-primary"></i>Seleccionar Tipo de Reporte
                    </h5>
                </div>
                <div class="card-body bg-white">
                    <form method="get" class="row g-3">
                        <div class="col-md-8">
                            <label for="tipo_reporte" class="form-label fw-semibold">Tipo de Reporte</label>
                            <select class="form-select form-select-lg border-2" id="tipo_reporte" name="tipo_reporte" onchange="this.form.submit()">
                                {% for tipo in tipos_reporte %}
                                    <option value="{{ tipo.value }}" {% if tipo_reporte == tipo.value %}selected{% endif %}>
                                        {{ tipo.label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-sync-alt me-2"></i>Actualizar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas rápidas -->
    {% if data %}
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1 opacity-90">Total de Registros</h6>
                            <h2 class="mb-0">{{ total_registros }}</h2>
                        </div>
                        <div class="text-primary-light">
                            <i class="fas fa-database fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1 opacity-90">Campos</h6>
                            <h2 class="mb-0">{{ headers|length }}</h2>
                        </div>
                        <div class="text-success-light">
                            <i class="fas fa-columns fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1 opacity-90">Fuente</h6>
                            <h2 class="mb-0 fs-6">Firebase RTDB</h2>
                        </div>
                        <div class="text-info-light">
                            <i class="fas fa-cloud fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h6 class="card-title mb-1 opacity-90">Formato</h6>
                            <h2 class="mb-0 fs-6">Tabla Interactiva</h2>
                        </div>
                        <div class="text-warning-light">
                            <i class="fas fa-table fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de resultados -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-table me-2 text-primary"></i>Datos del Reporte
                    </h5>
                    {% if data %}
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleColumnas()">
                            <i class="fas fa-columns me-1"></i>Columnas
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportarCSV()">
                            <i class="fas fa-file-csv me-1"></i>CSV
                        </button>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if data %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="reportTable">
                            <thead class="table-dark">
                                <tr>
                                    {% for header in headers %}
                                        <th class="text-center fw-semibold border-end">
                                            <div class="d-flex align-items-center justify-content-center">
                                                {{ header }}
                                                <i class="fas fa-sort ms-2 text-muted" style="font-size: 0.8em;"></i>
                                            </div>
                                        </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in data %}
                                <tr class="table-row-hover">
                                    {% for header in headers %}
                                    
                                        <td class="text-center align-middle border-end">
                                            {% with value=item|lookup:header %}
                                                {% if value == '-' %}
                                                    <span class="text-muted">-</span>
                                                {% elif 'Activo' in value or 'Disponible' in value or 'Sí' in value or 'Pagada' in value %}
                                                    <span class="badge bg-success">{{ value }}</span>
                                                {% elif 'Inactivo' in value or 'No' in value or 'Expirada' in value or 'Cancelada' in value %}
                                                    <span class="badge bg-danger">{{ value }}</span>
                                                {% elif 'Pendiente' in value or 'Reservado' in value or 'Suspendida' in value %}
                                                    <span class="badge bg-warning text-dark">{{ value }}</span>
                                                {% elif 'Ocupado' in value or 'Mantenimiento' in value or 'Vencida' in value %}
                                                    <span class="badge bg-secondary">{{ value }}</span>
                                                {% elif '$' in value %}
                                                    <span class="fw-semibold text-success">{{ value }}</span>
                                                {% elif '/' in value and value|length == 10 %}
                                                    <span class="text-primary">{{ value }}</span>
                                                {% else %}
                                                    {{ value }}
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <div class="text-muted mb-3">
                            <i class="fas fa-inbox fa-3x"></i>
                        </div>
                        <h5 class="text-muted">No se encontraron registros</h5>
                        <p class="text-muted">No hay datos disponibles para el tipo de reporte seleccionado.</p>
                        <a href="?" class="btn btn-primary">
                            <i class="fas fa-refresh me-2"></i>Intentar de nuevo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos adicionales -->
<style>
.bg-gradient-to-r {
    background: linear-gradient(90deg, #2563eb 0%, #1e40af 100%);
}

.table-row-hover:hover {
    background-color: #f8fafc !important;
    transition: background-color 0.2s ease;
}

.card {
    border-radius: 12px;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
}

.form-select {
    border-radius: 8px;
}

.shadow-sm {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
}

.shadow-lg {
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15) !important;
}

.table th {
    background-color: #1e293b !important;
    color: white !important;
    font-weight: 600;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge {
    font-size: 0.75em;
    font-weight: 600;
    padding: 0.5em 0.75em;
    border-radius: 6px;
}

.text-primary-light {
    color: rgba(255, 255, 255, 0.7) !important;
}

.text-success-light {
    color: rgba(255, 255, 255, 0.7) !important;
}

.text-info-light {
    color: rgba(255, 255, 255, 0.7) !important;
}

.text-warning-light {
    color: rgba(255, 255, 255, 0.7) !important;
}

@media (max-width: 768px) {
    .display-6 {
        font-size: 1.5rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .table-responsive {
        font-size: 0.85em;
    }
}
</style>

<!-- Scripts adicionales -->
<script>
function toggleColumnas() {
    // Crear modal para seleccionar columnas visibles
    const headers = {{ headers|safe }};
    let modalHtml = `
        <div class="modal fade" id="columnModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Seleccionar Columnas</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
    `;
    
    headers.forEach((header, index) => {
        modalHtml += `
            <div class="col-md-6 mb-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="col${index}" checked>
                    <label class="form-check-label" for="col${index}">${header}</label>
                </div>
            </div>
        `;
    });
    
    modalHtml += `
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="aplicarColumnas()">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Insertar modal si no existe
    if (!document.getElementById('columnModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    // Mostrar modal
    new bootstrap.Modal(document.getElementById('columnModal')).show();
}

function aplicarColumnas() {
    const table = document.getElementById('reportTable');
    const headers = {{ headers|safe }};
    
    headers.forEach((header, index) => {
        const checkbox = document.getElementById(`col${index}`);
        const headerCell = table.querySelector(`thead th:nth-child(${index + 1})`);
        const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
        
        if (checkbox.checked) {
            headerCell.style.display = '';
            cells.forEach(cell => cell.style.display = '');
        } else {
            headerCell.style.display = 'none';
            cells.forEach(cell => cell.style.display = 'none');
        }
    });
    
    // Cerrar modal
    bootstrap.Modal.getInstance(document.getElementById('columnModal')).hide();
}

function exportarCSV() {
    const table = document.getElementById('reportTable');
    if (!table) return;
    
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length; j++) {
            // Solo incluir columnas visibles
            if (cols[j].style.display !== 'none') {
                let cellText = cols[j].innerText.replace(/"/g, '""');
                row.push('"' + cellText + '"');
            }
        }
        csv.push(row.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `reporte_{{ tipo_reporte }}_${new Date().toISOString().slice(0, 10)}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Funcionalidad de ordenamiento
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('reportTable');
    if (!table) return;
    
    const headers = table.querySelectorAll('thead th');
    
    headers.forEach((header, index) => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            sortTable(index);
        });
    });
});

function sortTable(columnIndex) {
    const table = document.getElementById('reportTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determinar dirección de ordenamiento
    const isAscending = table.dataset.sortDirection !== 'asc';
    table.dataset.sortDirection = isAscending ? 'asc' : 'desc';
    
    // Ordenar filas
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].innerText.trim();
        const bValue = b.cells[columnIndex].innerText.trim();
        
        // Intentar ordenar como números si es posible
        const aNum = parseFloat(aValue.replace(/[^\d.-]/g, ''));
        const bNum = parseFloat(bValue.replace(/[^\d.-]/g, ''));
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
            return isAscending ? aNum - bNum : bNum - aNum;
        }
        
        // Ordenar como texto
        return isAscending ? 
            aValue.localeCompare(bValue) : 
            bValue.localeCompare(aValue);
    });
    
    // Reordenar DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar iconos de ordenamiento
    const allHeaders = table.querySelectorAll('thead th i.fa-sort');
    allHeaders.forEach(icon => {
        icon.className = 'fas fa-sort ms-2 text-muted';
    });
    
    const currentIcon = table.querySelectorAll('thead th')[columnIndex].querySelector('i');
    if (currentIcon) {
        currentIcon.className = isAscending ? 
            'fas fa-sort-up ms-2 text-primary' : 
            'fas fa-sort-down ms-2 text-primary';
    }
}

// Filtro de búsqueda rápida
function agregarBusqueda() {
    const cardHeader = document.querySelector('.card-header');
    if (!cardHeader || document.getElementById('searchInput')) return;
    
    const searchHtml = `
        <div class="input-group" style="max-width: 300px;">
            <span class="input-group-text bg-light border-end-0">
                <i class="fas fa-search text-muted"></i>
            </span>
            <input type="text" class="form-control border-start-0" 
                   id="searchInput" placeholder="Buscar en la tabla..."
                   onkeyup="filtrarTabla()">
        </div>
    `;
    
    cardHeader.insertAdjacentHTML('beforeend', searchHtml);
}

function filtrarTabla() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('reportTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
    });
}

// Inicializar funcionalidades adicionales
document.addEventListener('DOMContentLoaded', function() {
    agregarBusqueda();
    
    // Tooltip para badges
    const badges = document.querySelectorAll('.badge');
    badges.forEach(badge => {
        badge.setAttribute('title', badge.textContent);
        new bootstrap.Tooltip(badge);
    });
    
    // Animación de carga de filas
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach((row, index) => {
        row.style.opacity = '0';
        row.style.transform = 'translateY(20px)';
        setTimeout(() => {
            row.style.transition = 'all 0.3s ease';
            row.style.opacity = '1';
            row.style.transform = 'translateY(0)';
        }, index * 50);
    });
});

// Función para refrescar datos
function refrescarDatos() {
    const btn = event.target;
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
    btn.disabled = true;
    
    setTimeout(() => {
        window.location.reload();
    }, 1000);
}

// Modo oscuro toggle
function toggleModoOscuro() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

// Cargar preferencia de modo oscuro
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
});
</script>

<!-- Estilos para modo oscuro -->
<style>
.dark-mode {
    background-color: #1a202c !important;
    color: #e2e8f0 !important;
}

.dark-mode .card {
    background-color: #2d3748 !important;
    border-color: #4a5568 !important;
}

.dark-mode .table {
    color: #e2e8f0 !important;
}

.dark-mode .table-hover tbody tr:hover {
    background-color: #4a5568 !important;
}

.dark-mode .form-control,
.dark-mode .form-select {
    background-color: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #e2e8f0 !important;
}

.dark-mode .btn-outline-primary {
    color: #63b3ed !important;
    border-color: #63b3ed !important;
}

.dark-mode .btn-outline-secondary {
    color: #cbd5e0 !important;
    border-color: #cbd5e0 !important;
}

/* Responsive mejoras */
@media (max-width: 992px) {
    .card-header .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .input-group {
        max-width: 100% !important;
    }
}

@media (max-width: 576px) {
    .bg-gradient-to-r .d-flex {
        flex-direction: column;
        text-align: center;
    }
    
    .dropdown {
        margin-top: 1rem;
    }
    
    .table-responsive {
        font-size: 0.8em;
    }
    
    .badge {
        font-size: 0.6em;
    }
}

/* Animaciones */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card {
    animation: fadeInUp 0.5s ease-out;
}

/* Mejoras de accesibilidad */
.btn:focus,
.form-control:focus,
.form-select:focus {
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.25) !important;
}

.table th:focus {
    outline: 2px solid #2563eb;
    outline-offset: -2px;
}

/* Indicadores de carga */
.loading {
    position: relative;
    overflow: hidden;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}
</style>
{% endblock %}